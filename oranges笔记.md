---
这是在学习《orange's 一个操作系统的实现》过程中的笔记
2019.6.23.
---



[TOC]

# 第一阶段(参考书1-5章)

* 32位的代码段和数据段区别?

  > 段描述符D/B属性:
  >
  > * 对于代码段 : D=1,操作尺度和寻址尺度为32位;
  >
  > * 对于数据段 : B=1,该段数据为32位,只能被32位处理器使用;
  >
  > * 对于堆栈段 : B=1,隐含的堆栈操作为32位,堆栈指针用ESP

* bss段是干哈的?

  > 

* 异常产生时,cs.ip等是由谁压栈的?为什么错误码,向量号要自己压栈?见kernel.asm代码

  > * (ss , sp) , cs, ip ,(erro_code)都是由CPU在跳转到中断处理程序前压栈的.
  > * 向量号是由硬件直接传给CPU的, 而 kernel.asm中自己压栈的原因是为了给公用的中断处理程序传递这个参数.

* 为什么disp_str这些函数总是会产生越界异常?

  > 如果显示的字符串是常量(类似disp_str("string")), 或者static字符串, 这个函数总是会报错, 但是我改为栈上的字符串时, 就不会报错.
  >
  > * 考虑到cstart()函数(调用disp_str)是ELF格式, 难道是按ELF格式调整内核时, 数据段出了问题?
  >
  >   ==最后我找到bug了:==
  >
  >   *disp_str()*在函数中用到了**bl**, 但是该函数调用**没有压栈ebx**, 从而导致*ebx*发生变化. 之后的函数使用*ebx*寻址时, 直接导致*OverFlow*!
  >   
  >   ==我决定全面修改asm函数==

* 写一个elf格式文件的图形化工具

  



# 第二阶段(参考书6-7章)

* 中断重入时,在PCB中压栈不会破坏上一个中断压栈的寄存器组吗?

> 第一次中断中,切换到了内核栈

* PCB是在哪初始化的?

> kernel_main()

* 三个任务是如何运行的?

> kernel_main中的restart使用iret将完成特权级变换(0->1),从而返回(调用)三个任务



* I/O : 输入到一定数量的字符后, 就不接受任何按键了, 应该是扫描码缓冲满了?

> 修复了当printf()输出时向上卷轴的动作 和 满屏后向下卷轴动作的冲突bug(这个bug导致满屏后不再读取键盘输入了



# 第三阶段(参考书8-11章)

* 什么时候将虚拟地址(EA部分), 转化为线性地址?

> 函数__间__传递参数时, 使用虚拟地址(EA部分)
>
> 函数**内**使用EA去访问数据时, 要将其转化为线性地址
>
> 备注:	一般情况下, 不同进程的*段描述符*不同, \<ring3\>的进程内部可以直接使用EA, 因为地址转换的过程CPU帮你做了;
>
> 但是, 如果\<ring0\>的进程要访问\<ring3\>进程的数据, 由于两个进程的*段描述符*不同, 所以需要地址转换

* '&'操作符取来的地址都是EA
* 的什么时候该将虚拟地址转化为物理地址? 貌似保护模式下都因该呀? 但是之前一直没改...

> 难道是应为**<ring 0>**的内核状态默认采用的段描述符基址为0x00000000, 所以直接省略了;
>
> 而**<ring 1-3>**的任务/进程都有自己的LDT(在PCB里面), LDT中的段描述符基址**不一定**是0x00000000, 所以要设定va2la()函数来将任务/进程中使用的地址转换成内核中默认使用的线性地址(其实就是内核的线性地址, 因为内核中的段基址都是0)

* assert是不是多余了? 而且有些地方莫名奇妙的断言?

> 断言确实是多余的, 但是可以帮助读者思考为什么, 也是有用的.

* ==注意==kernel/kliba.asm中又增加了几个汇编函数, 作者的汇编一如既往的没有保存现场, 此处极易出==**bug**==
* 可能要重新设计IPC

> 因为我发现, 现阶段硬件中断INTERRUPT和一般的IPC是相连的, 但是INTERRUPT是随时发生的, 当其发生在msg_recv时, 大概率会导致逻辑问题(可能会"死锁")
>
> 所以, 如果OS的IPC模块升级困难, 可以考虑将INTERRUPT从IPC中移走

* 我就纳闷了, 为什么总有东西会修改sys_call_table[ ]的内容???

> 居然被exception_handler()中的err_description\[\]\[\]覆盖了......
>
> 难道就是因为这两个都放在了.rdata?
>
> 不, sys_call_table[ ]是在运行的时候该的...
>
> emmm, 我不想修改了, 再见osplus分支